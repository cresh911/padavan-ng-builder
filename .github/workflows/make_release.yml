name: Make firmware releases
run-name: "Make firmware releases #${{ github.run_number }}"

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up build tools
      run: |
        sudo apt update
        sudo apt install --no-install-recommends -y \
            autoconf automake autopoint cmake \
            bison build-essential flex gawk \
            gettext git gperf libtool libtool-bin \
            pkg-config fakeroot kmod cpio doxygen \
            texinfo help2man libncurses5-dev \
            zlib1g-dev libsqlite3-dev gcc-multilib \
            curl dos2unix unzip wget locales xxd libltdl-dev \
            libgmp3-dev libmpfr-dev libarchive-tools libblkid-dev
        sudo locale-gen --no-purge en_US.UTF-8 ru_RU.UTF-8
        export LANG="en_US.UTF-8"
        export LC_ALL="en_US.UTF-8"

    - name: Get variables
      run: |
        sed -i 's|\r$||g' variables
        grep -hE '^\s*PADAVAN_[A-Z0-9_]+=' variables >> "$GITHUB_ENV"
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV

    - name: Download sources and toolchain
      run: |
        git config --global --add safe.directory '*'
        git clone -b "${{ env.PADAVAN_BRANCH }}" "${{ env.PADAVAN_REPO }}" padavan-ng --depth=1
        git -C padavan-ng checkout "${{ env.PADAVAN_COMMIT }}"

        TAR_ARCH=""
        case "${{ env.PADAVAN_TOOLCHAIN_URL }}" in
            *.tzst|*.tar.zst) TAR_ARCH="--zstd" ;;
            *.txz|*.tar.xz) TAR_ARCH="--xz" ;;
        esac
        wget -qO- "${{ env.PADAVAN_TOOLCHAIN_URL }}" | tar -C padavan-ng $TAR_ARCH -xf - || :

    - name: Get padavan-ng variables
      run: |
        pushd padavan-ng/trunk
        sed -i 's|\r$||g' versions.inc
        grep -hE '^\s*FIRMWARE_[A-Z0-9_]+=' versions.inc >> "$GITHUB_ENV"
        echo "FIRMWARE_BUILDS_REV=$(git rev-parse --short HEAD 2>/dev/null)" >> "$GITHUB_ENV"

    - name: Run custom pre-build script
      run: '[[ -f pre-build.sh ]] && . pre-build.sh || :'

    - name: Build toolchain
      if: ${{ hashFiles('padavan-ng/toolchain/out/mipsel-linux-uclibc/sysroot/lib/libuClibc-*.so') == '' }}
      run: |
        pushd padavan-ng/toolchain
        ./clean_sources.sh
        ./build_toolchain.sh

    - name: Build firmware
      run: |
        set +e
        mkdir -p release
        for cfg in $(ls configs.release/*.config); do
            cp -f "$cfg" padavan-ng/trunk/.config
            echo "::group::Build $(basename "$cfg" .config)"
            echo "Waiting for the last 589 lines of logs (~10-20 minutes per config)..."

            pushd padavan-ng/trunk

            sed -i 's|\r$||g' .config
            . <(grep -hE '^\s*CONFIG_(VENDOR|FIRMWARE_PRODUCT_ID)=' .config)

            TEMP_LOG=$(mktemp)
            ./clear_tree.sh >/dev/null 2>&1
            ./build_firmware.sh > "$TEMP_LOG" 2>&1

            echo "Showing last 589 lines:"
            tail -n 589 "$TEMP_LOG"
            rm -f "$TEMP_LOG"

            popd

            FW_FILE_NAME="$(find padavan-ng/trunk/images -type f -regextype posix-extended -iregex ".*\.(trx|bin)$" \
                            -printf "%T@\t%f\n" | sort -V | tail -1 | cut -f2)"
             [[ -n $FW_FILE_NAME ]] || { echo "❌ Firmware file not found"; continue; }

            partitions="padavan-ng/trunk/configs/boards/${CONFIG_VENDOR}/${CONFIG_FIRMWARE_PRODUCT_ID}/partitions.config"
            max_fw_size="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$partitions")"
            fw_size="$(stat -c %s "padavan-ng/trunk/images/$FW_FILE_NAME")"

            if ((fw_size > max_fw_size)); then
              fw_size_fmtd="$(numfmt --grouping "$fw_size") bytes"
              max_fw_size_fmtd="$(numfmt --grouping "$max_fw_size") bytes"
              echo "❌ Firmware size ($fw_size_fmtd) exceeds max size ($max_fw_size_fmtd) for your target device"
              continue
            fi

            FW_PATH="release/${CONFIG_VENDOR}-${FW_FILE_NAME%.*}"
            [[ -f "${FW_PATH}.zip" ]] && FW_PATH="${FW_PATH}_$(basename "$cfg" .config)"
            zip -j ${FW_PATH}.zip "padavan-ng/trunk/images/$FW_FILE_NAME" "$cfg"
        done

    - name: Run custom post-build script
      run: '[[ -f post-build.sh ]] && . post-build.sh || :'

    - name: Check if release files exist
      run: |
        if ! ls release/*.zip >/dev/null 2>&1; then
          echo "❌ No files found in release directory"
          exit 1
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: release-${{ env.BUILD_TIMESTAMP }}
        name: Firmware 3.4.${{ env.FIRMWARE_ROOTFS_VER }}-${{ env.FIRMWARE_BUILDS_VER }}-${{ env.FIRMWARE_BUILDS_REV }}
        files: release/*.zip
        draft: false
        prerelease: false
        body: |
          Padavan firmware version 3.4.${{ env.FIRMWARE_ROOTFS_VER }}-${{ env.FIRMWARE_BUILDS_VER }}-${{ env.FIRMWARE_BUILDS_REV }}
          Repository used: ${{ env.PADAVAN_REPO }}
